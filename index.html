<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒä¸Šç”Ÿæ…‹ç“¶ - æ¨¡æ“¬éŠæˆ²</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚å­—é«” */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            /* é¿å…æ»‘å¡Šç­‰æ“ä½œé¸å–åˆ°æ–‡å­— */
            user-select: none;
        }

        /* éŠæˆ²å…ƒç´ çš„ç°¡å–®å‹•ç•« */
        .fish {
            transition: all 2s ease-in-out;
            transform: scaleX(1); /* åˆå§‹æ–¹å‘ */
        }
        
        /* æ°£æ³¡å‹•ç•« */
        @keyframes rise {
            0% {
                bottom: 10px;
                opacity: 1;
                transform: scale(0.5);
            }
            100% {
                bottom: 95%;
                opacity: 0;
                transform: scale(1.2);
            }
        }
        .bubble {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: rise 3s infinite ease-in;
            width: 10px;
            height: 10px;
            z-index: 5; /* (æ–°å¢) ç¢ºä¿æ°£æ³¡åœ¨è£é£¾ç‰©ä¹‹ä¸Š */
        }

        /* é€²åº¦æ¢å‹•ç•« */
        .progress-bar-fill {
            transition: width 0.5s ease-out, background-color 0.5s ease-out;
        }

        /* è¨Šæ¯å½ˆçª— */
        #message-box {
            transition: opacity 0.5s, transform 0.5s;
        }

        /* è®“æŒ‰éˆ•åœ¨ç¦ç”¨æ™‚æœ‰æ›´æ˜é¡¯çš„æ¨£å¼ */
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #9ca3af; /* Tailwind gray-400 */
        }

        /* ç·Šæ€¥æ›æ°´æŒ‰éˆ•åœ¨å•Ÿç”¨æ™‚çš„æ¨£å¼ */
        #emergency-water-change-btn:not(:disabled) {
             background-color: #dc2626; /* Tailwind red-600 */
        }
        #emergency-water-change-btn:not(:disabled):hover {
             background-color: #b91c1c; /* Tailwind red-700 */
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- æ¸¬é©—å½ˆçª— (Quiz Modal) -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4" id="quiz-title">ç”Ÿæ…‹å•é¡Œ</h3>
            <p class="text-gray-700 mb-6" id="quiz-question">é€™æ˜¯ä¸€å€‹å•é¡Œå—ï¼Ÿ</p>
            <div class="space-y-3">
                <button id="quiz-ans-1" data-answer="1" class="quiz-option w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition">é¸é … 1</button>
                <button id="quiz-ans-2" data-answer="2" class="quiz-option w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition">é¸é … 2</button>
            </div>
            <button id="quiz-cancel" class="w-full text-center text-gray-600 mt-4 hover:text-gray-800">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- (æ–°å¢) éŠæˆ²çµæŸ - æˆç¸¾ç‰ˆé¢ -->
    <div id="score-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 text-center">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">éŠæˆ²çµæŸ</h2>
            <p class="text-gray-700 text-lg mb-2">ä½ çš„ç”Ÿæ…‹ç“¶å­˜æ´»äº†ï¼š</p>
            <p id="score-day" class="text-5xl font-extrabold text-gray-900 mb-6">10 å¤©</p>
            
            <p class="text-gray-700 text-lg mb-3">ä½ ç²å¾—äº†ç¨±è™Ÿï¼š</p>
            <p id="score-title" class="text-2xl font-bold text-purple-600 mb-8">Lv.3 æ°´åŸŸå®ˆè­·è€…</p>

            <button id="score-close-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">
                æŸ¥çœ‹æ°´ç¼¸
            </button>
        </div>
    </div>

    <div class="game-container w-full max-w-6xl bg-white shadow-2xl rounded-2xl overflow-hidden">
        
        <!-- éŠæˆ²æ¨™é¡Œ -->
        <header class="bg-blue-800 text-white p-4 text-center">
            <h1 class="text-2xl font-bold">æŒä¸Šç”Ÿæ…‹ç“¶ ğŸ ğŸ¦ªğŸŒ¿</h1>
            <p id="game-day" class="text-sm opacity-90">ç¬¬ 1 å¤©</p>
        </header>

        <!-- è¨Šæ¯å½ˆçª— -->
        <div id="message-box" class="absolute top-20 left-1/2 -translate-x-1/2 bg-yellow-400 text-gray-900 px-6 py-3 rounded-lg shadow-lg opacity-0 transform -translate-y-10 z-50">
            <span id="message-text">é€™æ˜¯ä¸€æ¢è¨Šæ¯</span>
        </div>

        <!-- ä½ˆå±€å®¹å™¨ -->
        <div class="flex flex-col lg:flex-row">

            <!-- å·¦å´æ¬„ (æ°´ç¼¸ + å„€è¡¨æ¿) -->
            <div class="w-full lg:w-2/3">
                <!-- æ°´ç¼¸ (Aquarium) -->
                <main class="w-full bg-blue-100 p-4 relative" style="height: 500px;">
                    <!-- æ°´ç¼¸èƒŒæ™¯ -->
                    <div class="aquarium-bg absolute inset-0 bg-gradient-to-b from-blue-300 to-blue-400 overflow-hidden rounded-lg">
                        <!-- æ°´çš„æ¿åº¦ (è—»é¡) -->
                        <div id="water-turbidity" class="absolute inset-0 bg-green-800 transition-opacity duration-1000" style="opacity: 0.1;"></div>

                        <!-- (æ–°å¢) åº•æ²™ -->
                        <div class="absolute bottom-0 left-0 w-full h-8" style="background-color: #f7e7c1; z-index: 0;"></div>

                        <!-- (æ–°å¢) è£é£¾å²©çŸ³ -->
                        <span class="absolute text-5xl" style="bottom: 10px; left: 15%; z-index: 1;">ğŸª¨</span>
                        <span class="absolute text-3xl" style="bottom: 5px; left: 22%; z-index: 1;">ğŸª¨</span>

                        <!-- ç”Ÿç‰©ï¼šç¾…éé­š -->
                        <span id="fish" class="fish absolute text-7xl cursor-pointer" style="top: 40%; left: 50%; z-index: 10;">ğŸ </span> <!-- (ä¿®æ”¹) z-index -->
                        <span id="fish-2" class="fish absolute text-7xl cursor-pointer" style="top: 60%; left: 30%; z-index: 10;">ğŸ </span> <!-- (ä¿®æ”¹) z-index -->

                        <!-- ç”Ÿç‰©ï¼šä¸‰è§’å¸†èšŒ -->
                        <span id="mussel" class="absolute text-6xl" style="bottom: 20px; left: 35%; z-index: 10;">ğŸ¦ª</span> <!-- (ä¿®æ”¹) z-index & left -->
                        <span id="mussel-2" class="absolute text-6xl" style="bottom: 20px; left: 45%; z-index: 10;">ğŸ¦ª</span> <!-- (ä¿®æ”¹) z-index & left -->

                        <!-- ç”Ÿç‰©ï¼šæ°´è‰ -->
                        <div id="plant-container" class="absolute bottom-0 left-0 w-full h-24" style="z-index: 10;"> <!-- (ä¿®æ”¹) z-index -->
                            <!-- JS æœƒåœ¨é€™è£¡æ·»åŠ æ°´è‰ -->
                            <span class="absolute text-6xl" style="bottom: 10px; left: 70%;">ğŸŒ¿</span> <!-- (ä¿®æ”¹) text-4xl -> text-6xl -->
                            <span class="absolute text-6xl" style="bottom: 10px; left: 80%;">ğŸŒ¿</span> <!-- (ä¿®æ”¹) text-5xl -> text-6xl -->
                        </div>

                        <!-- æ°£æ³¡ -->
                        <div id="bubble-container"></div>

                    </div>
                </main>

                <!-- å„€è¡¨æ¿ (æ°´ç¼¸ä¸‹æ–¹) -->
                <section class="bg-gray-50 p-6 grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-200">
                    <!-- 1. ç”Ÿæ…‹å„€è¡¨æ¿ -->
                    <div>
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">ç”Ÿæ…‹å„€è¡¨æ¿</h2>
                        <!-- ç’°å¢ƒç‹€æ…‹ -->
                        <div class="space-y-3">
                            <!-- æº¶æ°§é‡ -->
                            <div class="gauge">
                                <label class="text-sm font-medium text-gray-700">æº¶æ°§é‡ (Oâ‚‚)</label>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="oxygen-bar" class="progress-bar-fill bg-blue-500 h-4 rounded-full" style="width: 70%;"></div>
                                </div>
                            </div>
                            <!-- pHå€¼ -->
                            <div class="gauge">
                                <label class="text-sm font-medium text-gray-700">pHå€¼ (é…¸é¹¼åº¦) <span id="ph-value">7.0</span></label>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="ph-bar" class="progress-bar-fill bg-purple-500 h-4 rounded-full" style="width: 50%;"></div>
                                </div>
                            </div>
                            <!-- æ¯’ç´  -->
                            <div class="gauge">
                                <label class="text-sm font-medium text-gray-700">æ¯’ç´ : <span id="toxin-value">10</span>%</label>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="toxin-bar" class="progress-bar-fill bg-green-600 h-4 rounded-full" style="width: 10%;"></div>
                                </div>
                            </div>
                            <!-- è—»é¡å¯†åº¦ -->
                            <div class="gauge">
                                <label class="text-sm font-medium text-gray-700">è—»é¡å¯†åº¦</label>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                                    <div id="algae-bar" class="progress-bar-fill bg-green-500 h-4 rounded-full" style="width: 30%;"></div>
                                </div>
                            </div>
                            <!-- æ°´æº« -->
                            <div class="gauge">
                                <label class="text-sm font-medium text-gray-700">æ°´æº«: <span id="temp-value">25</span>Â°C</label>
                                <input id="temp-slider" type="range" min="10" max="35" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- 2. ç”Ÿç‰©ç‹€æ…‹ -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">ç”Ÿç‰©ç‹€æ…‹</h3>
                        <div class="space-y-4">
                            <!-- ç¾…éé­š -->
                            <div class="bg-white p-3 rounded-lg shadow">
                                <span class="font-bold">ğŸ  ç¾…éé­š (x<span id="fish-count">2</span>)</span> <!-- (ä¿®æ”¹) å¢åŠ æ•¸é‡é¡¯ç¤º -->
                                <div class="text-sm mt-2">
                                    <label class="font-medium">å¥åº·: <span id="fish-health-value">100</span>%</label>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner mt-1">
                                        <div id="fish-health-bar" class="progress-bar-fill h-3 rounded-full bg-green-500" style="width: 100%;"></div>
                                    </div>
                                </div>
                                <div class="text-sm mt-2">
                                    <label class="font-medium">é£½é£Ÿåº¦: <span id="fish-hunger-value">100</span>%</label>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner mt-1">
                                        <div id="fish-hunger-bar" class="progress-bar-fill h-3 rounded-full bg-blue-500" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- ä¸‰è§’å¸†èšŒ -->
                            <div class="bg-white p-3 rounded-lg shadow">
                                <span class="font-bold">ğŸ¦ª ä¸‰è§’å¸†èšŒ (x<span id="mussel-count">2</span>)</span> <!-- (ä¿®æ”¹) å¢åŠ æ•¸é‡é¡¯ç¤º -->
                                <div class="text-sm mt-2">
                                    <label class="font-medium">å¥åº·: <span id="mussel-health-value">100</span>%</label>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner mt-1">
                                        <div id="mussel-health-bar" class="progress-bar-fill h-3 rounded-full bg-green-500" style="width: 100%;"></div>
                                    </div>
                                </div>
                                <div class="text-sm mt-2">
                                    <label class="font-medium">é£½é£Ÿåº¦: <span id="mussel-hunger-value">100</span>%</label>
                                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner mt-1">
                                        <div id="mussel-hunger-bar" class="progress-bar-fill h-3 rounded-full bg-blue-500" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- å³å´æ¬„ (è¡Œå‹• + æ—¥èªŒ) -->
            <aside class="w-full lg:w-1/3 bg-gray-100 p-6 border-l border-gray-200">
                <!-- 3. ç©å®¶è¡Œå‹• -->
                <h3 class="text-lg font-semibold mb-3">ç©å®¶è¡Œå‹•</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="feed-fish-btn" class="action-btn bg-blue-600 text-white p-3 rounded-lg shadow hover:bg-blue-700 transition duration-200">
                        é¤µé£Ÿç¾…éé­š
                    </button>
                    <button id="add-algae-btn" class="action-btn bg-green-600 text-white p-3 rounded-lg shadow hover:bg-green-700 transition duration-200">
                        æŠ•æ”¾è—»é¡
                    </button>
                    <button id="add-plant-btn" class="action-btn bg-teal-600 text-white p-3 rounded-lg shadow hover:bg-teal-700 transition duration-200">
                        ç¨®æ¤æ°´è‰
                    </button>
                    <button id="add-limewater-btn" class="action-btn bg-indigo-500 text-white p-3 rounded-lg shadow hover:bg-indigo-600 transition duration-200">
                        åŠ å…¥çŸ³ç°æ°´
                    </button>
                    <button id="clean-tank-btn" class="action-btn bg-purple-600 text-white p-3 rounded-lg shadow hover:bg-purple-700 transition duration-200">
                        æ¸…æ½”æ°´ç¼¸
                    </button>
                    <button id="emergency-water-change-btn" class="action-btn text-white p-3 rounded-lg shadow transition duration-200" disabled>
                        ç·Šæ€¥æ›æ°´
                    </button>
                    <button id="start-game-btn" class="action-btn bg-green-600 text-white p-3 rounded-lg shadow hover:bg-green-700 transition duration-200 col-span-1">
                        é–‹å§‹éŠæˆ²
                    </button>
                    <button id="reset-game-btn" class="action-btn bg-orange-500 text-white p-3 rounded-lg shadow hover:bg-orange-600 transition duration-200 col-span-1" disabled>
                        é‡æ–°é–‹å§‹
                    </button>
                </div>

                <!-- 4. äº‹ä»¶æ—¥èªŒ -->
                <h3 class="text-lg font-semibold mt-6 mb-3">äº‹ä»¶æ—¥èªŒ</h3>
                <div id="event-log-container" class="h-56 bg-gray-200 rounded-lg p-2 overflow-y-auto text-sm border border-gray-300"> <!-- (ä¿®æ”¹) h-80 -> h-56 -->
                    <!-- JS æœƒåœ¨é€™è£¡æ·»åŠ æ—¥èªŒ -->
                </div>

                <!-- (æ–°å¢) 5. éŠæˆ²è¦å‰‡æé†’ -->
                <div class="mt-4 bg-yellow-100 border border-yellow-300 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-yellow-800">éŠæˆ²æŠ€å·§æé†’</h3>
                    <div class="space-y-1 text-sm text-gray-700">
                        <p><strong>ç†æƒ³ç”Ÿå¢ƒ:</strong></p>
                        <ul class="list-disc list-inside pl-2">
                            <li>1) ç¶­æŒé«˜æº¶æ°§åº¦</li>
                            <li>2) pHå€¼ç¶­æŒ 7-8</li>
                            <li>3) æ¯’ç´ ç¶­æŒä½æ°´å¹³</li>
                        </ul>
                        <p class="pt-2"><strong>æ“ä½œæŠ€å·§:</strong></p>
                        <ul class="list-disc list-inside pl-2">
                            <li>1) æŠ•æ”¾è—»é¡åŠé¤µé£Ÿç¾…éé­šæœ‰åŠ©ç¶­æŒç”Ÿç‰©çš„é£½é£Ÿåº¦</li>
                            <li>2) é£½é£Ÿåº¦å½±éŸ¿ç”Ÿç‰©çš„å¥åº·å€¼</li>
                            <li>3) ç¨®æ¤æ°´è‰å¢åŠ æº¶æ°§é‡</li>
                            <li>4) æ°´è³ªæœƒéš¨æ™‚é–“è®Šé…¸ï¼ŒåŠ å…¥çŸ³ç°æ°´å¢åŠ pH</li>
                            <li>5) æ¸…æ½”æ°´ç¼¸å¯é™¤å»æ¯’ç´ </li>
                        </ul>
                    </div>
                </div>

            </aside>
        </div>
    </div>

    <script>
        // --- DOM å…ƒç´  ---
        const gameDayEl = document.getElementById('game-day');
        // ç’°å¢ƒ
        const oxygenBar = document.getElementById('oxygen-bar');
        const phBar = document.getElementById('ph-bar');
        const phValue = document.getElementById('ph-value');
        const toxinBar = document.getElementById('toxin-bar');
        const toxinValue = document.getElementById('toxin-value');
        const algaeBar = document.getElementById('algae-bar');
        const tempValue = document.getElementById('temp-value');
        const tempSlider = document.getElementById('temp-slider');
        const waterTurbidity = document.getElementById('water-turbidity');
        const startGameBtn = document.getElementById('start-game-btn');
        // ç”Ÿç‰©
        const fishHealthValue = document.getElementById('fish-health-value');
        const fishHealthBar = document.getElementById('fish-health-bar');
        const fishHungerValue = document.getElementById('fish-hunger-value');
        const fishHungerBar = document.getElementById('fish-hunger-bar');
        const musselHealthValue = document.getElementById('mussel-health-value');
        const musselHealthBar = document.getElementById('mussel-health-bar');
        const musselHungerValue = document.getElementById('mussel-hunger-value');
        const musselHungerBar = document.getElementById('mussel-hunger-bar');
        
        const fishEl = document.getElementById('fish'); // (ä¿ç•™) ç‚ºäº† moveFish çš„ querySelector
        const musselEl = document.getElementById('mussel'); // (ä¿ç•™)
        const plantContainer = document.getElementById('plant-container');
        const bubbleContainer = document.getElementById('bubble-container');
        // æŒ‰éˆ•
        const feedFishBtn = document.getElementById('feed-fish-btn');
        const addAlgaeBtn = document.getElementById('add-algae-btn');
        const addPlantBtn = document.getElementById('add-plant-btn');
        const addLimewaterBtn = document.getElementById('add-limewater-btn');
        const cleanTankBtn = document.getElementById('clean-tank-btn');
        const waterChangeBtn = document.getElementById('emergency-water-change-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        // è¨Šæ¯
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        // æ¸¬é©—
        const quizModal = document.getElementById('quiz-modal');
        const quizTitle = document.getElementById('quiz-title');
        const quizQuestion = document.getElementById('quiz-question');
        const quizAns1 = document.getElementById('quiz-ans-1');
        const quizAns2 = document.getElementById('quiz-ans-2');
        const quizCancel = document.getElementById('quiz-cancel');
        const quizOptions = document.querySelectorAll('.quiz-option');
        // æ—¥èªŒ
        const eventLogContainer = document.getElementById('event-log-container');
        // (æ–°å¢) æˆç¸¾ç‰ˆé¢
        const scoreModal = document.getElementById('score-modal');
        const scoreDay = document.getElementById('score-day');
        const scoreTitle = document.getElementById('score-title');
        const scoreCloseBtn = document.getElementById('score-close-btn');

        // --- éŠæˆ²ç‹€æ…‹ (GameState) ---
        let gameState = {
            day: 1,
            light: true, // true = ç™½å¤©, false = å¤œæ™š
            // ç’°å¢ƒåƒæ•¸
            oxygen: 70,    // 0-100
            ph: 7.0,       // 0-14
            toxin: 10,     // 0-100
            algae: 30,     // 0-100
            temp: 25,
            plantCount: 2,
            // (æ–°å¢) ç”Ÿç‰©æ•¸é‡
            fishCount: 2,
            musselCount: 2,
            // èšŒçš„è¨ˆæ™‚å™¨
            musselAlgaeLowDuration: 0, // (Req 2)
            musselHungerLowDuration: 0, // (Req 3)
            // (æ–°å¢) é­šçš„è¨ˆæ™‚å™¨
            fishAlgaeLowDuration: 0,
            fishHungerLowDuration: 0,
            // ç”Ÿç‰©åƒæ•¸
            fish: {
                health: 100,
                hunger: 100,
            },
            mussel: {
                health: 100,
                hunger: 100,
            },
            gameOver: true, // (è£œå…¨) éŠæˆ²é–‹å§‹æ™‚æ‡‰ç‚º trueï¼Œç›´åˆ°æŒ‰ä¸‹ "é–‹å§‹éŠæˆ²"
            gameStarted: false // (è£œå…¨) è¿½è¹¤éŠæˆ²æ˜¯å¦å·²é–‹å§‹
        };

        let gameLoop; // éŠæˆ²å¾ªç’°
        let pendingAction = null; // å„²å­˜å¾…åŸ·è¡Œçš„å‹•ä½œ
        let currentQuiz = null; // å„²å­˜ç›®å‰çš„æ¸¬é©—
        let gameTicks = 0;
        let isWaterChangeOnCooldown = false; // (æ–°å¢) ç·Šæ€¥æ›æ°´å†·å»
        const initialGameState = JSON.parse(JSON.stringify(gameState)); // å„²å­˜åˆå§‹ç‹€æ…‹

        // --- æ¸¬é©—è³‡æ–™åº« ---
        const quizDatabase = {
            easy: [
                { q: "ä¸‰è§’å¸†èšŒçš„ä¸»è¦é£Ÿç‰©æ˜¯ä»€éº¼ï¼Ÿ", a1: "è—»é¡", a2: "é­šç³§", correct: 1, hint: "å­¸ç¿’ç›®æ¨™ 1ï¼šä¸‰è§’å¸†èšŒéæ¿¾æ°´ä¸­è—»é¡ç‚ºé£Ÿç‰©" },
                { q: "ä»€éº¼ç”Ÿç‰©å¯ä»¥å¢åŠ æ°´ä¸­çš„æº¶è§£æ°§ï¼Ÿ", a1: "ç¾…éé­š", a2: "æ°´è‰", correct: 2, hint: "å­¸ç¿’ç›®æ¨™ 4ï¼šç¨®æ¤æ°´è‰å¯å¢åŠ æ°´ä¸­æº¶è§£æ°§" },
                { q: "é¤µé£Ÿç¾…éé­šæœ‰ä»€éº¼å¥½è™•ï¼Ÿ", a1: "æ¸›å°‘ç‰ åƒè—»é¡", a2: "å¢åŠ èšŒçš„é£Ÿç‰©", correct: 1, hint: "å­¸ç¿’ç›®æ¨™ 2ï¼šé¤µé£Ÿé­šç³§å¯æ¸›å°‘ï¼ˆèˆ‡èšŒçš„ï¼‰ç«¶çˆ­" },
                { q: "ç•¶æ°´è³ªè®Šé…¸ (pHå€¼é™ä½) æ™‚ï¼Œæ‡‰åŠ å…¥ä»€éº¼ä¾†èª¿ç¯€ï¼Ÿ", a1: "çŸ³ç°æ°´", a2: "æ›´å¤šè—»é¡", correct: 1, hint: "çŸ³ç°æ°´æ˜¯é¹¼æ€§çš„ï¼Œå¯ä»¥ä¸­å’Œé…¸æ€§ã€‚" },
                { q: "é­šçš„æ’æ³„ç‰©æœƒå°æ°´è³ªé€ æˆä»€éº¼å½±éŸ¿ï¼Ÿ", a1: "å¢åŠ æ¯’ç´ ", a2: "å¢åŠ æº¶è§£æ°§", correct: 1, hint: "å­¸ç¿’ç›®æ¨™ 3ï¼šæ’æ³„ç‰©æœƒå¢åŠ æ¯’ç´ " },
            ],
            hard: [
                { q: "å¦‚æœè—»é¡çˆ†ç™¼ (å¤ªå¤šè—»é¡) ä¸¦ä¸”åœ¨æ™šä¸Šï¼Œæº¶è§£æ°§æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ", a1: "å¤§å¹…å¢åŠ ", a2: "å¤§å¹…æ¸›å°‘", correct: 2, hint: "è—»é¡åœ¨æ™šä¸Šå’Œé­šä¸€æ¨£ï¼Œåªæœƒå‘¼å¸æ¶ˆè€—æ°§æ°£ã€‚" },
                { q: "ç¾…éé­šå’Œä¸‰è§’å¸†èšŒä¹‹é–“å­˜åœ¨ä»€éº¼é—œä¿‚ï¼Ÿ", a1: "ç«¶çˆ­é—œä¿‚ (æ¶è—»é¡)", a2: "å…±ç”Ÿé—œä¿‚ (äº’ç›¸å¹«åŠ©)", correct: 1, hint: "å­¸ç¿’ç›®æ¨™ 2ï¼šç‰ å€‘éƒ½æœƒæ¶ˆè€—è—»é¡ã€‚" },
                { q: "é­šçš„æ’æ³„ç‰©å’Œæ®˜é¤Œæœƒä½¿æ°´è³ª...", a1: "è®Šé…¸ (pHé™ä½)", a2: "è®Šé¹¼ (pHå¢åŠ )", correct: 1, hint: "å­¸ç¿’ç›®æ¨™ 3ï¼šåˆ†è§£éç¨‹æœƒç”¢ç”Ÿé…¸æ€§ç‰©è³ªã€‚" },
            ]
        };


        // --- éŠæˆ²åŠŸèƒ½ ---

        /**
         * (è£œå…¨) é¡¯ç¤ºè¨Šæ¯ (å½ˆçª—)
         * @param {string} msg - è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {string} type - 'info' (é»ƒ) æˆ– 'error' (ç´…) æˆ– 'system' (è—)
         */
        function showMessage(msg, type = 'info') {
            messageText.innerText = msg;
            messageBox.classList.remove('bg-yellow-400', 'bg-red-500', 'text-white', 'bg-blue-500', 'text-gray-900');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else if (type === 'system') {
                 messageBox.classList.add('bg-blue-500', 'text-white');
            } else {
                messageBox.classList.add('bg-yellow-400', 'text-gray-900');
            }
            
            messageBox.style.opacity = 1;
            messageBox.style.transform = 'translate(-50%, 0)';

            setTimeout(() => {
                messageBox.style.opacity = 0;
                messageBox.style.transform = 'translate(-50%, -10px)';
            }, 3000);
        }

        /**
         * (è£œå…¨) è¨˜éŒ„äº‹ä»¶åˆ°æ—¥èªŒ
         * @param {string} msg - è¦è¨˜éŒ„çš„è¨Šæ¯
         * @param {string} type - 'info' (é»ƒ), 'error' (ç´…), 'log' (è—), 'system' (ç°)
         */
        function logEvent(msg, type = 'info') {
            const logEntry = document.createElement('p');
            let color = 'text-gray-700'; // default
            
            if (type === 'error') {
                color = 'text-red-600 font-bold';
            } else if (type === 'info') {
                color = 'text-yellow-800';
            } else if (type === 'log') {
                color = 'text-blue-700';
            } else if (type === 'system') {
                color = 'text-gray-500 italic';
            }
            
            // (ä¿®å¾©) ç¢ºä¿åœ¨ gameState.day å¯ç”¨æ™‚æ‰ä½¿ç”¨
            const dayText = (gameState && typeof gameState.day !== 'undefined') ? `[ç¬¬${gameState.day}å¤©] ` : '';
            logEntry.className = `py-0.5 ${color}`;
            logEntry.innerText = `${dayText}${msg}`;
            
            if (eventLogContainer) {
                eventLogContainer.appendChild(logEntry);
                eventLogContainer.scrollTop = eventLogContainer.scrollHeight;
            } else {
                console.error("eventLogContainer not found, log:", msg);
            }
        }

        /**
         * (è£œå…¨) é™åˆ¶æ•¸å€¼
         * @param {number} value - æ•¸å€¼
         * @returns {number} 
         */
        function clamp(value, min = 0, max = 100) {
            const val = parseFloat(value);
            if (isNaN(val)) return min;
            return Math.max(min, Math.min(max, val));
        }

        /**
         * (è£œå…¨) é¡¯ç¤ºæ¸¬é©—
         * @param {string} difficulty - 'easy' æˆ– 'hard'
         * @param {string} actionName - ç­”å°å¾Œè¦åŸ·è¡Œçš„å‹•ä½œ
         */
        function showQuiz(difficulty, actionName) {
            if (gameState.gameOver) return;
            
            pendingAction = actionName;
            const questionPool = quizDatabase[difficulty];
            currentQuiz = questionPool[Math.floor(Math.random() * questionPool.length)];

            quizTitle.innerText = (difficulty === 'hard') ? "é«˜é›£åº¦ç”Ÿæ…‹å•é¡Œ" : "ç”Ÿæ…‹å•é¡Œ";
            quizQuestion.innerText = currentQuiz.q;
            quizAns1.innerText = currentQuiz.a1;
            quizAns2.innerText = currentQuiz.a2;

            quizModal.classList.remove('hidden');
        }

        /** (è£œå…¨) éš±è—æ¸¬é©— */
        function hideQuiz() {
            quizModal.classList.add('hidden');
            pendingAction = null;
            currentQuiz = null;
        }

        /** (è£œå…¨) è™•ç†æ¸¬é©—ç­”æ¡ˆ */
        function handleQuizAnswer(answerIndex) {
            if (!currentQuiz) return;

            if (answerIndex === currentQuiz.correct) {
                showMessage("ç­”å°äº†ï¼åŸ·è¡Œæ“ä½œã€‚", "info");
                // ç­”å°äº†ï¼ŒåŸ·è¡Œå¾…å®šå‹•ä½œ
                switch (pendingAction) {
                    case 'feedFish':
                        logic_feedFish();
                        break;
                    case 'addAlgae':
                        logic_addAlgae();
                        break;
                    case 'addPlant':
                        logic_addPlant();
                        break;
                    case 'addLimewater':
                        logic_addLimewater();
                        break;
                    case 'cleanTank':
                        logic_cleanTank();
                        break;
                    case 'waterChange':
                        logic_waterChange();
                        break;
                }
            } else {
                const correctText = (currentQuiz.correct === 1) ? currentQuiz.a1 : currentQuiz.a2;
                showMessage(`ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯: ${correctText}`, "error");
                logEvent(`æ¸¬é©—æç¤ºï¼š${currentQuiz.hint}`, "system");
            }
            hideQuiz();
        }


        /**
         * (æ–°å¢) å˜—è©¦åŸ·è¡Œä¸€å€‹å‹•ä½œï¼Œæœ‰ 20% æ©Ÿç‡éœ€è¦ç­”é¡Œ
         * @param {string} difficulty - 'easy' æˆ– 'hard'
         * @param {string} actionName - å‹•ä½œçš„åç¨± (e.g., 'feedFish')
         */
        function attemptAction(difficulty, actionName) {
            if (gameState.gameOver) return; // éŠæˆ²çµæŸæ™‚ä¸èƒ½åŸ·è¡Œå‹•ä½œ

            if (Math.random() < 0.2) { // (ä¿®æ”¹) 40% -> 20%
                // 20% æ©Ÿç‡ï¼Œé¡¯ç¤ºæ¸¬é©—
                logEvent("æœ¬æ¬¡æ“ä½œéœ€è¦å›ç­”å•é¡Œ...", "system");
                showQuiz(difficulty, actionName);
            } else {
                // 80% æ©Ÿç‡ï¼Œç›´æ¥åŸ·è¡Œ
                showMessage("æ“ä½œæˆåŠŸï¼(æœ¬æ¬¡å…ç­”é¡Œ)", "info");
                
                // ç«‹å³åŸ·è¡Œå‹•ä½œ
                switch (actionName) {
                    case 'feedFish':
                        logic_feedFish();
                        break;
                    case 'addAlgae':
                        logic_addAlgae();
                        break;
                    case 'addPlant':
                        logic_addPlant();
                        break;
                    case 'addLimewater':
                        logic_addLimewater();
                        break;
                    case 'cleanTank':
                        logic_cleanTank();
                        break;
                    case 'waterChange':
                        logic_waterChange();
                        break;
                }
            }
        }


        /**
         * é‡æ–°ç¹ªè£½æ‰€æœ‰æ°´è‰
         */
        function redrawPlants() {
            plantContainer.innerHTML = ""; // æ¸…é™¤ç¾æœ‰çš„æ°´è‰
            let baseLeft = 70; // å¾å³å´ 70% é–‹å§‹
            let plantSpacing = 5; // æ°´è‰é–“è·
            for (let i = 0; i < gameState.plantCount; i++) {
                const newPlant = document.createElement('span');
                newPlant.className = 'absolute text-6xl'; // (ä¿®æ”¹) text-4xl -> text-6xl
                newPlant.innerText = 'ğŸŒ¿';
                
                let leftPos = baseLeft - (i * plantSpacing);
                let bottomPos = 10;

                if (i >= 10) {
                    leftPos = baseLeft - ((i - 10) * plantSpacing);
                    bottomPos = 30; // ç¬¬äºŒè¡Œ
                }
                
                newPlant.style.left = `${leftPos}%`;
                newPlant.style.bottom = `${bottomPos}px`;
                plantContainer.appendChild(newPlant);
            }
        }


        /**
         * æ›´æ–°UI
         */
        function updateUI() {
            const state = gameState;
            
            gameDayEl.innerText = `ç¬¬ ${state.day} å¤© (${state.light ? 'ç™½å¤©' : 'å¤œæ™š'})`;
            
            oxygenBar.style.width = `${state.oxygen}%`;
            
            phValue.innerText = state.ph.toFixed(1);
            phBar.style.width = `${(state.ph / 14) * 100}%`;
            let phColor = 'bg-purple-500'; 
            if (state.ph < 6.5 || state.ph > 7.5) phColor = 'bg-yellow-500';
            if (state.ph < 6.0 || state.ph > 8.0) phColor = 'bg-red-500';
            phBar.className = `progress-bar-fill h-4 rounded-full ${phColor}`;

            const toxinPercent = clamp(state.toxin, 0, 100);
            toxinBar.style.width = `${toxinPercent}%`;
            toxinValue.innerText = Math.round(toxinPercent); 

            toxinBar.classList.remove('bg-red-600', 'bg-yellow-500', 'bg-green-600');
            if (toxinPercent > 80) {
                toxinBar.classList.add('bg-red-600');
            } else if (toxinPercent > 50) {
                toxinBar.classList.add('bg-yellow-500');
            } else {
                toxinBar.classList.add('bg-green-600');
            }

            algaeBar.style.width = `${state.algae}%`;
            waterTurbidity.style.opacity = (state.algae / 100) * 0.7;

            // (è£œå…¨) ç”Ÿç‰©ç‹€æ…‹
            const fishHealth = Math.round(state.fish.health);
            fishHealthValue.innerText = fishHealth;
            fishHealthBar.style.width = `${fishHealth}%`;
            fishHealthBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
            if (fishHealth < 30) {
                fishHealthBar.classList.add('bg-red-500');
            } else if (fishHealth < 60) {
                fishHealthBar.classList.add('bg-yellow-500');
            } else {
                fishHealthBar.classList.add('bg-green-500');
            }

            const fishHunger = Math.round(state.fish.hunger);
            fishHungerValue.innerText = fishHunger;
            fishHungerBar.style.width = `${fishHunger}%`;

            const musselHealth = Math.round(state.mussel.health);
            musselHealthValue.innerText = musselHealth;
            musselHealthBar.style.width = `${musselHealth}%`;
            musselHealthBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
            if (musselHealth < 30) {
                musselHealthBar.classList.add('bg-red-500');
            } else if (musselHealth < 60) {
                musselHealthBar.classList.add('bg-yellow-500');
            } else {
                musselHealthBar.classList.add('bg-green-500');
            }

            const musselHunger = Math.round(state.mussel.hunger);
            musselHungerValue.innerText = musselHunger;
            musselHungerBar.style.width = `${musselHunger}%`;

            // (è£œå…¨) å•Ÿç”¨/ç¦ç”¨ç·Šæ€¥æ›æ°´
            // (ä¿®æ”¹) ç§»é™¤èˆŠçš„è‡ªå‹•ç¦ç”¨é‚è¼¯ã€‚ç¾åœ¨åªç”±å†·å»å’ŒéŠæˆ²ç‹€æ…‹(startGame/endGame)æ§åˆ¶ã€‚
            // waterChangeBtn.disabled = (state.toxin <= 80 && state.oxygen >= 10); 

        }

        // --- (è£œå…¨) ç©å®¶è¡Œå‹•é‚è¼¯ (Player Action Logic) ---

        function logic_feedFish() {
            gameState.fish.hunger = clamp(gameState.fish.hunger + 10, 0, 100); // (ä¿®æ”¹ Req 3) 40 -> 10
            gameState.toxin = clamp(gameState.toxin + (5 * gameState.fishCount), 0, 100); // (ä¿®æ”¹) æ®˜é¤Œ * é­šæ•¸é‡
            logEvent(`ä½ é¤µé£Ÿäº†ç¾…éé­š(x${gameState.fishCount})ï¼Œé£½é£Ÿåº¦ +10%ã€‚`, "log"); // (ä¿®æ”¹) æ›´æ–°æ—¥èªŒ
        }

        function logic_addAlgae() {
            gameState.algae = clamp(gameState.algae + 30, 0, 100);
            logEvent("ä½ æŠ•æ”¾äº†è—»é¡ã€‚ (å­¸ç¿’ç›®æ¨™ 1)", "log");
        }

        function logic_addPlant() {
            if (gameState.plantCount >= 15) {
                showMessage("æ°´è‰å¤ªå¤šï¼Œç¨®ä¸ä¸‹äº†ï¼", "info");
                return;
            }
            gameState.plantCount++;
            // (ç”¨æˆ¶è¦æ±‚) ç¨®æ¤æ°´è‰æ™‚ï¼Œç«‹å³å¢åŠ æº¶æ°§é‡
            gameState.oxygen = clamp(gameState.oxygen + 30, 0, 100);
            redrawPlants();
            logEvent("ä½ ç¨®æ¤äº†ä¸€æ£µæ°´è‰ï¼Œæº¶æ°§é‡å¢åŠ äº†ï¼ (å­¸ç¿’ç›®æ¨™ 4)", "log");
        }

        function logic_addLimewater() {
            gameState.ph = clamp(gameState.ph + 1.5, 0, 14); // å¼·åŠ›ä¸­å’Œ
            logEvent("ä½ åŠ å…¥äº†çŸ³ç°æ°´ä¾†ä¸­å’Œé…¸æ€§ã€‚", "log");
        }

        function logic_cleanTank() {
            gameState.toxin = clamp(gameState.toxin - 40, 0, 100);
            gameState.algae = clamp(gameState.algae - 20, 0, 100); // æ¸…ç†æ™‚ä¹Ÿæœƒç§»é™¤ä¸€äº›è—»é¡
            logEvent("ä½ æ¸…æ½”äº†æ°´ç¼¸ï¼Œæ¯’ç´ é™ä½äº†ã€‚", "log");
        }

        function logic_waterChange() {
            // (ä¿®æ”¹) æª¢æŸ¥æ˜¯å¦éœ€è¦åŸ·è¡Œ
            if (gameState.toxin <= 80 && gameState.oxygen >= 10) {
                showMessage("æ°´è³ªå°šæœªé”åˆ°å±æ€¥æ¨™æº–ï¼Œç„¡éœ€æ›æ°´ã€‚", "info");
                // (é‡è¦) é›–ç„¶ç„¡éœ€æ›æ°´ï¼Œä½†å› ç‚ºç©å®¶é€šéäº†æ¸¬é©—ï¼Œæˆ‘å€‘ä»ç„¶è§¸ç™¼å†·å»
            } else {
                gameState.toxin = clamp(gameState.toxin - 70, 0, 100);
                gameState.oxygen = clamp(gameState.oxygen + 50, 0, 100);
                gameState.ph = 7.0; // æ›æ°´é‡ç½®pH
                logEvent("ç·Šæ€¥æ›æ°´ï¼æ°´è³ªæš«æ™‚ç©©å®šä¸‹ä¾†ã€‚", "error");
            }

            // (æ–°å¢) è§¸ç™¼10ç§’å†·å»
            isWaterChangeOnCooldown = true;
            waterChangeBtn.disabled = true;
            logEvent("ç·Šæ€¥æ›æ°´é€²å…¥10ç§’å†·å»...", "system");

            setTimeout(() => {
                isWaterChangeOnCooldown = false;
                if (!gameState.gameOver) {
                    waterChangeBtn.disabled = false;
                }
                logEvent("ç·Šæ€¥æ›æ°´å·²æº–å‚™å°±ç·’ã€‚", "system");
            }, 10000); // 10ç§’
        }

        // --- (è£œå…¨) éŠæˆ²ä¸»å¾ªç’° (Game Loop) ---

        /**
         * ä¸»è¦éŠæˆ²æ›´æ–°å¾ªç’° (Game Loop)
         */
        function updateGame() {
            if (gameState.gameOver) return;

            const state = gameState;
            const optimalTemp = (state.temp >= 15 && state.temp <= 30);
            
            // --- 0. è‡ªç„¶è®ŠåŒ– ---
            state.ph = clamp(state.ph - 0.02, 0, 14); 
            state.algae = clamp(state.algae - 0.1, 0, 100);

            // --- 1. æ¶ˆè€—/ç”¢ç”Ÿ ---
            
            // ç¾…éé­š
            state.fish.hunger = clamp(state.fish.hunger - 2, 0, 100); // (ä¿®æ”¹ Req 1) 1 -> 2
            let phDrop = 0.05; 
            if (state.toxin > 50) phDrop += 0.05;
            if (state.toxin > 80) phDrop += 0.05;
            state.ph = clamp(state.ph - (phDrop * state.fishCount), 0, 14); // (ä¿®æ”¹) è®Šé…¸ * é­šæ•¸é‡

            state.toxin = clamp(state.toxin + (0.2 * state.fishCount), 0, 100); // (ä¿®æ”¹) æ¯’ç´  * é­šæ•¸é‡
            state.oxygen = clamp(state.oxygen - (1.5 * state.fishCount), 0, 100); // (ä¿®æ”¹) è€—æ°§ * é­šæ•¸é‡
            
            if (state.fish.hunger < 30 && state.algae > 10) {
                state.algae = clamp(state.algae - (5 * state.fishCount), 0, 100); // (ä¿®æ”¹) åƒè—» * é­šæ•¸é‡
                state.fish.hunger = clamp(state.fish.hunger + 10, 0, 100);
            }

            // ä¸‰è§’å¸†èšŒ
            state.mussel.hunger = clamp(state.mussel.hunger - 2, 0, 100); // (ä¿®æ”¹ Req 1) æ¯ç§’éƒ½æ›´é¤“ (1 -> 2)
            if (state.algae > 10) {
                let algaeEaten = Math.min(state.algae, 2); // (é€™æ˜¯ per mussel)
                if (optimalTemp) {
                    state.algae = clamp(state.algae - (algaeEaten * state.musselCount), 0, 100); // (ä¿®æ”¹) ç¸½å…±åƒæ‰çš„è—»é¡
                    state.mussel.hunger = clamp(state.mussel.hunger + algaeEaten * 5, 0, 100); // (ä¸è®Š) é£¢é¤“åº¦æ˜¯ group-based
                }
            }
            state.oxygen = clamp(state.oxygen - (1 * state.musselCount), 0, 100); // (ä¿®æ”¹) è€—æ°§ * èšŒæ•¸é‡

            // --- 1.5. æ¤ç‰©è…çˆ› ---
            if (gameTicks > 0 && gameTicks % 2 === 0 && state.plantCount > 0) { 
                let plantsToDie = Math.ceil(state.plantCount * 0.2); 
                state.plantCount = Math.max(0, state.plantCount - plantsToDie);
                
                state.oxygen = clamp(state.oxygen - 20, 0, 100);
                state.toxin = clamp(state.toxin + 10, 0, 100); 
                state.ph = clamp(state.ph - 0.5, 0, 14); 

                redrawPlants(); 
                logEvent(`æœ‰ ${plantsToDie} æ£µæ°´è‰è…çˆ›äº†ï¼æ°´è³ªæƒ¡åŒ–ï¼`, "error"); 
            }


            // --- 2. æ ¸å¿ƒæº¶æ°§é‚è¼¯ ---
            if (state.plantCount > 0 && state.light) {
                state.oxygen = clamp(state.oxygen * 1.05, 0, 100);
            } else if (state.plantCount === 0) {
                state.oxygen = clamp(state.oxygen * 0.95, 0, 100);
            }

            if (state.light && state.algae > 10) {
                 state.oxygen = clamp(state.oxygen + (state.algae / 10), 0, 100);
            }
            
            if (!state.light) {
                state.oxygen = clamp(state.oxygen - (state.algae / 10), 0, 100);
                state.oxygen = clamp(state.oxygen - (state.plantCount * 0.5), 0, 100);
            }

            // --- 3. å¥åº·æª¢æŸ¥ (Health Checks) ---
            
            // (è£œå…¨) å»ºç«‹ä¸€å€‹æ¨™è¨˜ï¼Œçœ‹æœ¬-tick-æ˜¯å¦æ‰£è¡€
            let fishTookDamage = false;

            // --- (ç”¨æˆ¶è¦æ±‚) æ–°å¢ é­šçš„é£¢é¤“/å¥åº· é‚è¼¯ (Req 2 & 4) ---
            
            // (Req 2) ç•¶è—»é¡å¯†åº¦ä½æ–¼50%æ¯ç¶­æŒ2tickï¼Œé­šçš„é£½é£Ÿåº¦æ¸›å°‘10%
            if (state.algae < 50) {
                state.fishAlgaeLowDuration++;
                if (state.fishAlgaeLowDuration > 0 && state.fishAlgaeLowDuration % 2 === 0) {
                    state.fish.hunger = clamp(state.fish.hunger - 10, 0, 100);
                    logEvent("è­¦å‘Šï¼šè—»é¡å¯†åº¦ä½æ–¼ 50%ï¼Œç¾…éé­šé£½é£Ÿåº¦ä¸‹é™ï¼", "info");
                }
            } else {
                state.fishAlgaeLowDuration = 0; // è—»é¡å……è¶³ï¼Œé‡ç½®
            }

            // (Req 4) ç•¶é£½é£Ÿåº¦ä½æ–¼50%ç¶­æŒæ¯ç¶­æŒ2tickï¼Œé­šçš„å¥åº·å€¼æ¸›å°‘10%
            if (state.fish.hunger < 50) {
                state.fishHungerLowDuration++;
                if (state.fishHungerLowDuration > 0 && state.fishHungerLowDuration % 2 === 0) {
                    state.fish.health = clamp(state.fish.health - 10, 0, 100);
                    fishTookDamage = true; // (é‡è¦) æ¨™è¨˜æ‰£è¡€
                    logEvent("è­¦å‘Šï¼šç¾…éé­šé£¢é¤“éä¹…ï¼Œå¥åº·ä¸‹é™ 10%ï¼", "error");
                }
            } else {
                state.fishHungerLowDuration = 0; // é£½é£Ÿåº¦å……è¶³ï¼Œé‡ç½®
            }
            // --- çµæŸ (Req 2 & 4) ---


            // é­š
            if (state.fish.hunger <= 0) {
                state.fish.health = clamp(state.fish.health - 5, 0, 100); // é¤“åˆ°æ‰£è¡€ (ä¿ç•™)
                fishTookDamage = true;
            }
            
            // --- (ç”¨æˆ¶è¦æ±‚) æ–°çš„åš´æ ¼å¥åº·æª¢æŸ¥ ---
            // (ä¿®æ”¹) èª¿æ•´æ‡²ç½°é–¾å€¼
            if (state.oxygen < 10) { // (åŸ < 30)
                state.fish.health = clamp(state.fish.health - 10, 0, 100); // ç¼ºæ°§
            }
            if (state.toxin > 50) { // (åŸ > 30)
                state.fish.health = clamp(state.fish.health - 10, 0, 100); // ä¸­æ¯’
            }
            if (state.ph < 6.0) { // (åŸ < 6.9)
                state.fish.health = clamp(state.fish.health - 10, 0, 100); // pHä¸é©
                fishTookDamage = true;
            }
            // (å‚™è¨»ï¼šä¿ç•™åŸæœ‰çš„ high-pH æª¢æŸ¥ï¼Œå› ç‚ºç”¨æˆ¶åªæåˆ° "ä½æ–¼")
            if (state.ph > 8.0) {
                 state.fish.health = clamp(state.fish.health - 3, 0, 100); // (ä¿ç•™) pHéé«˜
                 fishTookDamage = true;
            }
            // --- çµæŸ ---

            // --- (ç”¨æˆ¶è¦æ±‚) æ–°å¢å¥åº·æ¢å¾© ---
            if (!fishTookDamage) {
                // å¦‚æœæœ¬-tick-æ²’æœ‰æ‰£è¡€ï¼Œæª¢æŸ¥æ¢å¾©æ¢ä»¶
                const isWellFed = state.fish.hunger > 60;
                const isCleanWater = state.toxin < 30;
                const isGoodPh = (state.ph >= 7.0 && state.ph <= 8.0);

                if (isWellFed || isCleanWater || isGoodPh) {
                    // åªè¦æ»¿è¶³ä»»ä¸€æ¢ä»¶ï¼Œå°±æ¢å¾©å¥åº·
                    state.fish.health = clamp(state.fish.health + 5, 0, 100); // (ä¿®æ”¹) æ¯-tick-æ¢å¾© 5%
                }
            }
            // --- çµæŸ ---
            
            // èšŒ
            let musselTookDamage = false; // (æ–°å¢)

            // --- (ç”¨æˆ¶è¦æ±‚) ç§»é™¤èˆŠçš„è—»é¡éä½æ‡²ç½° ---
            /*
            if (state.algae < 30) {
                state.algaeLowDuration++; // ç´¯ç©è¨ˆæ•¸
                // æ¯ç¶­æŒ 2 ticksï¼Œå°±æ‰£ä¸€æ¬¡
                if (state.algaeLowDuration > 0 && state.algaeLowDuration % 2 === 0) {
                    state.mussel.health = clamp(state.mussel.health - 30, 0, 100);
                    musselTookDamage = true;
                    logEvent("è­¦å‘Šï¼šè—»é¡å¯†åº¦éä½å·²ä¹…ï¼Œä¸‰è§’å¸†èšŒå¥åº·å¤§å¹…ä¸‹é™ 30%ï¼", "error");
                }
            } else {
                state.algaeLowDuration = 0; // è—»é¡å……è¶³ï¼Œé‡ç½®è¨ˆæ•¸å™¨
            }
            */
            // --- çµæŸ (ç§»é™¤) ---

            // --- (ç”¨æˆ¶è¦æ±‚) æ–°å¢ èšŒçš„é£¢é¤“/å¥åº· é‚è¼¯ (Req 2 & 3) ---
            
            // (Req 2) ç•¶è—»é¡å¯†åº¦ä½æ–¼50%æ¯ç¶­æŒ2tickï¼ŒèšŒçš„é£½é£Ÿåº¦æ¸›å°‘10%
            if (state.algae < 50) {
                state.musselAlgaeLowDuration++;
                if (state.musselAlgaeLowDuration > 0 && state.musselAlgaeLowDuration % 2 === 0) {
                    state.mussel.hunger = clamp(state.mussel.hunger - 10, 0, 100);
                    logEvent("è­¦å‘Šï¼šè—»é¡å¯†åº¦ä½æ–¼ 50%ï¼Œä¸‰è§’å¸†èšŒé£½é£Ÿåº¦ä¸‹é™ï¼", "info");
                }
            } else {
                state.musselAlgaeLowDuration = 0; // è—»é¡å……è¶³ï¼Œé‡ç½®
            }

            // (Req 3) ç•¶é£½é£Ÿåº¦ä½æ–¼50%ç¶­æŒæ¯ç¶­æŒ2tickï¼ŒèšŒçš„å¥åº·å€¼æ¸›å°‘10%
            if (state.mussel.hunger < 50) {
                state.musselHungerLowDuration++;
                if (state.musselHungerLowDuration > 0 && state.musselHungerLowDuration % 2 === 0) {
                    state.mussel.health = clamp(state.mussel.health - 10, 0, 100);
                    musselTookDamage = true;
                    logEvent("è­¦å‘Šï¼šä¸‰è§’å¸†èšŒé£¢é¤“éä¹…ï¼Œå¥åº·ä¸‹é™ 10%ï¼", "error");
                }
            } else {
                state.musselHungerLowDuration = 0; // é£½é£Ÿåº¦å……è¶³ï¼Œé‡ç½®
            }
            // --- çµæŸ (Req 2 & 3) ---


            if (state.mussel.hunger <= 0) {
                state.mussel.health = clamp(state.mussel.health - 5, 0, 100); // é¤“åˆ°æ‰£è¡€ (ä¿ç•™)
                musselTookDamage = true; // (æ–°å¢)
            }
            if (!optimalTemp) {
                state.mussel.health = clamp(state.mussel.health - 3, 0, 100); // æº«åº¦ä¸é© (ä¿ç•™)
                musselTookDamage = true; // (æ–°å¢)
            }

            // --- (ç”¨æˆ¶è¦æ±‚) æ–°çš„åš´æ ¼å¥åº·æª¢æŸ¥ ---
            // (ä¿®æ”¹) èª¿æ•´æ‡²ç½°é–¾å€¼
            if (state.oxygen < 10) { // (åŸ < 30)
                state.mussel.health = clamp(state.mussel.health - 10, 0, 100); // ç¼ºæ°§
                musselTookDamage = true; // (æ–°å¢)
            }
            if (state.toxin > 50) { // (åŸ > 30)
                state.mussel.health = clamp(state.mussel.health - 10, 0, 100); // ä¸­æ¯’ (æ–°å¢)
                musselTookDamage = true; // (æ–°å¢)
            }
            if (state.ph < 6.0) { // (åŸ < 6.9)
                state.mussel.health = clamp(state.mussel.health - 10, 0, 100); // pHä¸é© (æ–°å¢)
                musselTookDamage = true; // (æ–°å¢)
            }
            // --- çµæŸ ---

            // --- (æ–°å¢) èšŒçš„å¥åº·æ¢å¾© ---
            if (!musselTookDamage) {
                const isWellFed = state.mussel.hunger > 60;
                const isCleanWater = state.toxin < 30;
                // (optimalTemp å·²åœ¨å‡½å¼é–‹é ­å®šç¾©)

                if (isWellFed || isCleanWater || optimalTemp) {
                    state.mussel.health = clamp(state.mussel.health + 5, 0, 100); // (ä¿®æ”¹) æ¯-tick-æ¢å¾© 5%
                }
            }
            // --- çµæŸ ---


            // --- 4. ç‹€æ…‹æ—¥èªŒ (Status Logging) ---
            if (gameTicks % 5 === 0) { // æ¯ 5 Ticks æª¢æŸ¥ä¸€æ¬¡
                if (state.mussel.hunger < 20 && state.mussel.health > 0) logEvent("è­¦å‘Šï¼šä¸‰è§’å¸†èšŒå¿«é¤“æ­»äº†ï¼(è—»é¡ä¸è¶³)", "info");
                if (state.fish.hunger < 20 && state.fish.health > 0) logEvent("è­¦å‘Šï¼šç¾…éé­šå¾ˆé¤“ï¼(å¿«é¤µç‰ )", "info");
                
                // --- (ç”¨æˆ¶è¦æ±‚) æ›´æ–°è­¦å‘Šé–¾å€¼ ---
                // (ä¿®æ”¹) èª¿æ•´è­¦å‘Šé–¾å€¼
                if (state.oxygen < 10) logEvent("è­¦å‘Šï¼šæ°´ä¸­æº¶æ°§æ¥µä½ï¼", "error"); // (åŸ < 30)
                if (state.toxin > 50) logEvent("è­¦å‘Šï¼šæ¯’ç´ åš´é‡ç´¯ç©ï¼", "error"); // (åŸ > 30)
                if (state.ph < 6.0) logEvent("è­¦å‘Šï¼šæ°´è³ªåš´é‡åé…¸ï¼", "error"); // (åŸ < 6.9)
                // (ä¿ç•™) pH éé«˜è­¦å‘Š
                if (state.ph > 8.0 && state.fish.health > 0) logEvent("è­¦å‘Šï¼špHå€¼å·²é”å±éšªç¯„åœï¼(éé¹¼)", "error");
            }
            
            // --- 5. éŠæˆ²çµæŸæª¢æŸ¥ (Game Over Checks) ---
            // (ç”¨æˆ¶è¦æ±‚) æ°§æ°£è€—ç›¡
            if (state.oxygen <= 0) {
                 document.querySelectorAll('.fish').forEach(f => f.innerText = "ğŸ’€"); // (ä¿®æ”¹) 
                 document.getElementById('mussel').innerText = "âœ–ï¸";
                 document.getElementById('mussel-2').innerText = "âœ–ï¸";
                 endGame("éŠæˆ²çµæŸï¼šæ°´ä¸­æ°§æ°£è€—ç›¡ï¼Œæ‰€æœ‰ç”Ÿç‰©çª’æ¯æ­»äº¡ã€‚");
                 return; // (é‡è¦) ç«‹å³åœæ­¢ï¼Œé˜²æ­¢æª¢æŸ¥å…¶ä»–æ­»äº¡æ¢ä»¶
            }

            if (state.fish.health <= 0) {
                document.querySelectorAll('.fish').forEach(f => f.innerText = "ğŸ’€"); // (ä¿®æ”¹) 
                endGame("éŠæˆ²çµæŸï¼šç¾…éé­šæ­»æ–¼æ°´è³ªæƒ¡åŒ–æˆ–é£¢é¤“ã€‚");
            }
            if (state.mussel.health <= 0) {
                document.getElementById('mussel').innerText = "âœ–ï¸"; // (ä¿®æ”¹)
                document.getElementById('mussel-2').innerText = "âœ–ï¸";
                endGame("éŠæˆ²çµæŸï¼šä¸‰è§’å¸†èšŒæ­»æ–¼æ°´è³ªæƒ¡åŒ–æˆ–é£¢é¤“ã€‚");
            }

            // --- 6. å‹åˆ©æª¢æŸ¥ (è£œå…¨) ---
            if (state.day > 30) {
                endGame("æ­å–œï¼ä½ æˆåŠŸç¶­æŒç”Ÿæ…‹å¹³è¡¡ 30 å¤©ï¼ä½ è´äº†ï¼");
            }

            // --- 7. æ›´æ–°UIå’Œè¨ˆæ•¸å™¨ ---
            gameTicks++;
            // æ¯ 10 Ticks (20ç§’) æ›ä¸€æ¬¡æ—¥å¤œ
            if (gameTicks % 10 === 0) {
                gameState.light = !gameState.light;
                if (gameState.light) {
                    gameState.day++; // é€²å…¥æ–°çš„ä¸€å¤©
                    logEvent(`--- ç¬¬ ${gameState.day} å¤©é–‹å§‹ ---`, "system");
                }
            }

            updateUI(); // æœ€å¾Œæ›´æ–°ç•«é¢
        }

        // --- (è£œå…¨) éŠæˆ²æ§åˆ¶ ---

        /**
         * çµæŸéŠæˆ²
         * @param {string} message - çµæŸè¨Šæ¯
         */
        function endGame(message) {
            if (gameState.gameOver) return; // é˜²æ­¢é‡è¤‡è§¸ç™¼
            
            gameState.gameOver = true;
            clearInterval(gameLoop);
            logEvent(message, "error");
            showMessage(message, "error");

            // ç¦ç”¨æ‰€æœ‰è¡Œå‹•æŒ‰éˆ•
            document.querySelectorAll('.action-btn').forEach(btn => {
                // ä¿ç•™ "é‡æ–°é–‹å§‹" æŒ‰éˆ•çš„å•Ÿç”¨ç‹€æ…‹
                if (btn.id !== 'reset-game-btn' && btn.id !== 'start-game-btn') {
                     btn.disabled = true;
                }
            });
            
            // å•Ÿç”¨ "é‡æ–°é–‹å§‹"
            resetGameBtn.disabled = false;

            // (æ–°å¢) é¡¯ç¤ºæˆç¸¾ç‰ˆé¢
            showScoreboard();
        }

        /**
         * (æ–°å¢) é¡¯ç¤ºæˆç¸¾ç‰ˆé¢
         */
        function showScoreboard() {
            const daysSurvived = gameState.day;
            let title = "";

            if (daysSurvived <= 2) {
                title = "Lv1. è¦‹ç¿’é£¼é¤Šå“¡";
            } else if (daysSurvived <= 5) {
                title = "Lv2. ç†Ÿç·´ç…§è­·è€…";
            } else if (daysSurvived <= 10) {
                title = "Lv.3 æ°´åŸŸå®ˆè­·è€…";
            } else if (daysSurvived <= 20) {
                title = "Lv.4 ç”Ÿæ…‹å¤§å¸«";
            } else {
                title = "Lv.5 å‚³å¥‡ç”Ÿæ…‹ç“¶";
            }

            scoreDay.innerText = `${daysSurvived} å¤©`;
            scoreTitle.innerText = title;

            scoreModal.classList.remove('hidden');
        }


        /**
         * åˆå§‹åŒ–/é‡ç½®éŠæˆ²
         */
        function initGame() {
            // åœæ­¢èˆŠçš„å¾ªç’°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (gameLoop) clearInterval(gameLoop);
            
            // æ·±åº¦è¤‡è£½åˆå§‹ç‹€æ…‹
            gameState = JSON.parse(JSON.stringify(initialGameState));
            gameState.gameOver = true; // (è£œå…¨) å°šæœªé–‹å§‹
            gameState.gameStarted = false;
            
            gameTicks = 0;
            isWaterChangeOnCooldown = false; // (æ–°å¢) é‡ç½®å†·å»
            // gameState.algaeLowDuration = 0; // (èˆŠ) é‡ç½®è—»é¡è¨ˆæ•¸å™¨ (å·²ç§»é™¤)
            gameState.musselAlgaeLowDuration = 0; // (æ–°å¢) é‡ç½® (Req 2)
            gameState.musselHungerLowDuration = 0; // (æ–°å¢) é‡ç½® (Req 3)
            // (æ–°å¢) é‡ç½®é­šçš„è¨ˆæ™‚å™¨
            gameState.fishAlgaeLowDuration = 0;
            gameState.fishHungerLowDuration = 0;
            
            // (æ–°å¢) éš±è—æˆç¸¾ç‰ˆé¢
            scoreModal.classList.add('hidden');

            // é‡ç½®UI
            updateUI();
            redrawPlants();
            document.querySelectorAll('.fish').forEach(f => f.innerText = "ğŸ "); // (ä¿®æ”¹)
            document.getElementById('mussel').innerText = "ğŸ¦ª"; // (ä¿®æ”¹)
            document.getElementById('mussel-2').innerText = "ğŸ¦ª";
            
            // æ¸…ç©ºæ—¥èªŒ
            eventLogContainer.innerHTML = "";
            logEvent("æ­¡è¿ä¾†åˆ°æŒä¸Šç”Ÿæ…‹ç“¶ï¼", "system");
            logEvent("ä½ çš„ç›®æ¨™æ˜¯ç¶­æŒç”Ÿæ…‹å¹³è¡¡ 30 å¤©ã€‚", "system");
            
            // (ç§»é™¤) é¡¯ç¤ºéŠæˆ²è¦å‰‡ (å·²ç§»è‡³HTML)
            /*
            logEvent("--- éŠæˆ²è¦å‰‡ ---", "system");
            logEvent("ç†æƒ³ç”Ÿå¢ƒ: 1)ç¶­æŒé«˜æº¶æ°§åº¦ 2)pHå€¼ç¶­æŒ7-8 3)æ¯’ç´ ç¶­æŒä½æ°´å¹³", "system");
            logEvent("--- æ“ä½œæŠ€å·§ ---", "system");
            logEvent("1) æŠ•æ”¾è—»é¡åŠé¤µé£Ÿç¾…éé­šæœ‰åŠ©ç¶­æŒç”Ÿç‰©çš„é£½é£Ÿåº¦", "system");
            logEvent("2) é£½é£Ÿåº¦å½±éŸ¿ç”Ÿç‰©çš„å¥åº·å€¼", "system");
            logEvent("3) ç¨®æ¤æ°´è‰å¢åŠ æº¶æ°§é‡", "system");
            logEvent("4) æ°´è³ªæœƒéš¨æ™‚é–“è®Šé…¸ï¼Œå½±éŸ¿ç”Ÿç‰©çš„å¥åº·å€¼ï¼ŒåŠ å…¥çŸ³ç°æ°´å¢åŠ pH", "system");
            logEvent("5) æ¸…æ½”æ°´ç¼¸å¯é™¤å»æ¯’ç´ ", "system");
            logEvent("-----------------", "system");
            */
            
            logEvent("æŒ‰ä¸‹ [é–‹å§‹éŠæˆ²] ä¾†å•Ÿå‹•ç”Ÿæ…‹å¾ªç’°ã€‚", "system");
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.action-btn').forEach(btn => btn.disabled = true);
            startGameBtn.disabled = false;
        }

        /** (è£œå…¨) é–‹å§‹éŠæˆ² */
        function startGame() {
            if (gameState.gameStarted) return; // é˜²æ­¢é‡è¤‡é–‹å§‹

            gameState.gameOver = false;
            gameState.gameStarted = true;
            
            // ç¦ç”¨é–‹å§‹æŒ‰éˆ•ï¼Œå•Ÿç”¨å…¶ä»–æŒ‰éˆ•
            startGameBtn.disabled = true;
            resetGameBtn.disabled = false;
            feedFishBtn.disabled = false;
            addAlgaeBtn.disabled = false;
            addPlantBtn.disabled = false;
            addLimewaterBtn.disabled = false;
            cleanTankBtn.disabled = false;
            // waterChangeBtn ä¿æŒç¦ç”¨ï¼Œç›´åˆ°æ¢ä»¶è§¸ç™¼

            logEvent("--- éŠæˆ²é–‹å§‹ï¼ç”Ÿæ…‹å¾ªç’°å•Ÿå‹• ---", "system");
            
            // å•Ÿå‹•éŠæˆ²å¾ªç’° (æ¯ 4 ç§’æ›´æ–°ä¸€æ¬¡) (ä¿®æ”¹: 2000 -> 4000)
            gameLoop = setInterval(updateGame, 4000);
        }

        // --- (è£œå…¨) é¡å¤–å‹•ç•« ---

        /** é­šçš„éš¨æ©Ÿæ¸¸å‹• */
        function moveFish() {
            if (gameState.gameOver && gameState.gameStarted) return; // éŠæˆ²çµæŸ(éåˆå§‹)æ™‚åœæ­¢æ¸¸å‹•
            if (gameState.fish.health <= 0) return; // æ­»äº¡æ™‚åœæ­¢

            const aquarium = document.querySelector('.aquarium-bg');
            const aquariumWidth = aquarium.offsetWidth;
            const aquariumHeight = aquarium.offsetHeight;
            
            // (ä¿®æ”¹) è®“æ‰€æœ‰çš„é­šéƒ½æ¸¸å‹•
            document.querySelectorAll('.fish').forEach(fishEl => {
                const fishSize = fishEl.offsetWidth; 

                // éš¨æ©Ÿæ–°ä½ç½® (é™åˆ¶åœ¨æ°´ç¼¸ 80% çš„ç¯„åœå…§)
                const newX = Math.random() * (aquariumWidth - fishSize);
                const newY = (Math.random() * (aquariumHeight * 0.8)) + (aquariumHeight * 0.1); // é¿å…å¤ªé«˜æˆ–å¤ªä½

                // æª¢æŸ¥æ–¹å‘
                const currentX = parseFloat(fishEl.style.left.replace('%', '')) / 100 * aquariumWidth || (aquariumWidth / 2);
                if (newX > currentX) {
                    fishEl.style.transform = 'scaleX(1)'; // å‘å³
                } else {
                    fishEl.style.transform = 'scaleX(-1)'; // å‘å·¦
                }

                fishEl.style.left = `${(newX / aquariumWidth) * 100}%`;
                fishEl.style.top = `${(newY / aquariumHeight) * 100}%`;
            });

            setTimeout(moveFish, 3000 + Math.random() * 2000); // 3-5ç§’æ¸¸å‹•ä¸€æ¬¡
        }

        /** ç”¢ç”Ÿæ°£æ³¡ */
        function createBubble() {
            if (gameState.gameOver) return; // éŠæˆ²çµæŸåœæ­¢ç”¢ç”Ÿ

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // éš¨æ©Ÿä½ç½® (åœ¨æ°´ç¼¸ 20% åˆ° 80% å¯¬åº¦ä¹‹é–“)
            bubble.style.left = `${20 + Math.random() * 60}%`;
            // éš¨æ©Ÿå‹•ç•«å»¶é²
            bubble.style.animationDelay = `${Math.random() * 3}s`;
            // éš¨æ©Ÿå¤§å°
            const size = 5 + Math.random() * 10;
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;

            bubbleContainer.appendChild(bubble);

            // æ°£æ³¡æ¶ˆå¤±å¾Œç§»é™¤ DOM
            setTimeout(() => {
                bubble.remove();
            }, 3000); // æ‡‰èˆ‡å‹•ç•«æ™‚é–“åŒ¹é…
        }

        // --- äº‹ä»¶ç›£è½å™¨ (Event Listeners) ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- éŠæˆ²æ§åˆ¶æŒ‰éˆ• ---
            startGameBtn.addEventListener('click', startGame);
            resetGameBtn.addEventListener('click', initGame);

            // --- ç©å®¶è¡Œå‹•æŒ‰éˆ• (ç¶å®šæ¸¬é©—) ---
            // (ä¿®æ”¹) ç¶å®šåˆ°æ–°çš„ attemptAction å‡½å¼
            feedFishBtn.addEventListener('click', () => attemptAction('easy', 'feedFish'));
            addAlgaeBtn.addEventListener('click', () => attemptAction('easy', 'addAlgae'));
            addPlantBtn.addEventListener('click', () => attemptAction('easy', 'addPlant'));
            addLimewaterBtn.addEventListener('click', () => attemptAction('easy', 'addLimewater'));
            cleanTankBtn.addEventListener('click', () => attemptAction('hard', 'cleanTank'));
            
            // (ä¿®æ”¹) ç·Šæ€¥æ›æ°´æŒ‰éˆ•ä½¿ç”¨ç¨ç«‹é‚è¼¯
            waterChangeBtn.addEventListener('click', () => {
                if (gameState.gameOver) return;
                
                // 1. æª¢æŸ¥å†·å»
                if (isWaterChangeOnCooldown) {
                    showMessage("ç·Šæ€¥æ›æ°´å†·å»ä¸­ (10ç§’)...", "info");
                    return;
                }
                
                // 2. å¿…é ˆå›ç­”é«˜éšå•é¡Œ
                logEvent("ç·Šæ€¥æ›æ°´éœ€è¦å›ç­”é«˜éšå•é¡Œ...", "system");
                showQuiz('hard', 'waterChange');
            });

            // --- æ¸¬é©—å½ˆçª—æŒ‰éˆ• ---
            quizOptions.forEach(btn => {
                btn.addEventListener('click', () => {
                    handleQuizAnswer(parseInt(btn.dataset.answer));
                });
            });
            quizCancel.addEventListener('click', hideQuiz);

            // (æ–°å¢) æˆç¸¾ç‰ˆé¢é—œé–‰æŒ‰éˆ•
            scoreCloseBtn.addEventListener('click', () => {
                scoreModal.classList.add('hidden');
            });

            // --- ç’°å¢ƒæ§åˆ¶ ---
            tempSlider.addEventListener('input', (e) => {
                gameState.temp = parseInt(e.target.value);
                tempValue.innerText = gameState.temp;
                
                // (è£œå…¨) æº«åº¦è­¦å‘Š
                if (!gameState.gameOver && (gameState.temp < 15 || gameState.temp > 30)) {
                    showMessage("è­¦å‘Šï¼šç›®å‰æ°´æº«ä¸é©åˆç”Ÿç‰©ç”Ÿé•·ï¼", "info");
                }
            });

            // --- åˆå§‹è¨­ç½® ---
            initGame();
            
            // (è£œå…¨) å•Ÿå‹•å‹•ç•«
            moveFish();
            setInterval(createBubble, 1000); // æ¯ç§’å˜—è©¦ç”¢ç”Ÿä¸€å€‹æ°£æ³¡
        });

    </script>
</body>
</html>
